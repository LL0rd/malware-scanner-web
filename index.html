<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YARA-Scanner 1.0.0 (lite)</title>
</head>

<body>

    <fieldset>
        <legend>Regeln (URL)</legend>
        <input type="url" id="rules_url_input"
            style="width: 500px"
            value="">
    </fieldset>

    <fieldset>
        <legend>ignorierte Datei-Endungen</legend>
        <input type="text" id="ignored_extensions"
            style="width: 500px"
            value="">
    </fieldset>

    <fieldset>
        <legend>maximale Datei-Größe (KB)</legend>
        <input type="number" id="max_file_size"
            min="0"
            max="1200"
            step="100"
            value="">
    </fieldset>

    <fieldset>
        <legend>Dateien auswählen</legend>
        <input type="file" id="filepicker" name="fileList" webkitdirectory multiple /> <span id="scan_status"></span>
    </fieldset>

    <fieldset>
        <legend>Dateien (zu scannen)</legend>
        <textarea id="listing" readonly rows="10" style="min-width: 500px"></textarea>
    </fieldset>

    <fieldset>
        <legend>Dateien (ignoriert)</legend>
        <textarea id="listing_ignored" readonly rows="10" style="min-width: 500px"></textarea>
    </fieldset>

    <fieldset>
        <legend>Dateien (schädlich)</legend>
        <textarea id="listing_malicious" readonly rows="10" style="min-width: 500px"></textarea>
    </fieldset>

    <fieldset>
        <legend>Changelog</legend>
        1.0.0 (2021-09-13)
        <ul>
            <li>initiale Version</li>
            <li>YARA-Regeln von https://www.rfxn.com/downloads/rfxn.yara</li>
            <li>YARA 4.0.2</li>
        </ul>
    </fieldset>

    <script src="libyara-wasm.js?v=1.1.0"></script>

    <script>
        // code based on https://github.com/imp0rtp3/Yobi

        function resetLists() {
            window.scan_queue = [];
            window.scan_error = false;
            document.getElementById('listing').value = '';
            document.getElementById('listing_ignored').value = '';
            document.getElementById('listing_malicious').value = '';
            document.getElementById('scan_status').innerText = 'Scan nicht gestartet';
        }

        resetLists();
        document.getElementById('filepicker').value = '';
        document.getElementById('rules_url_input').value = 'https://gist.githubusercontent.com/DanielRuf/1547ffa519b16d5dc25b1f7a024e30fc/raw/da0e0984462ad5ae08786c51120776c022d63b0a/rfxn.yara';
        document.getElementById('ignored_extensions').value = 'DS_Store,css,js,txt,json,jpeg,jpg,png,gif';
        document.getElementById('max_file_size').value = 500;

        document.getElementById('filepicker').addEventListener('change', async function (event) {
            resetLists();
            let output_all = document.getElementById('listing');
            let output_ignored = document.getElementById('listing_ignored');
            const files = event.target.files;
            window.scan_start = Date.now();
            ////console.log('Received following files:');
            ////console.table(Array.from(files));

            document.getElementById('scan_status').innerText = 'Scan läuft';

            const ignored_extensions = document.getElementById('ignored_extensions');
            const ignored_extensions_array = ignored_extensions.value.split(',');

            const max_file_size = document.getElementById('max_file_size').value;
            const rules_url = document.getElementById('rules_url_input').value;;

            let settings = localStorage.getItem('settings');

            if (!settings) {
                settings = { 'yara_rules_url': rules_url };
                localStorage.setItem('settings', JSON.stringify(settings));
            } else {
                settings = JSON.parse(settings);
                if (settings.yara_rules_url !== rules_url) {
                    localStorage.setItem('settings', JSON.stringify(settings));
                }
            }

            await get_yara_rules(rules_url);

            for (let i = 0; i < files.length; i++) {
                const file_current = files[i];
                const name = file_current.name;
                const lastDot = name.lastIndexOf('.');
                const ext = name.substring(lastDot + 1);
                ////console.log('Reading following file:');
                if (ignored_extensions_array.includes(ext)) {
                    output_ignored.value += `${file_current.webkitRelativePath} (extension: ${ext})\n`;
                    continue;
                }

                
                if (file_current.size >= (max_file_size * 1024) ) {
                    output_ignored.value += `${file_current.webkitRelativePath} (size: ${file_current.size} bytes)\n`;
                    continue;
                }
                const file_data = {
                    lastModified: file_current.lastModified,
                    name: file_current.name,
                    size: file_current.size,
                    type: file_current.type,
                    ext: ext,
                    webkitRelativePath: file_current.webkitRelativePath
                };
                ////console.table(file_data);
                output_all.value += `${file_current.webkitRelativePath}\n`;
                const reader = new FileReader();
                reader.onload = function (evt) {
                    window.scan_queue.push([file_data, evt.target.result]);
                }
                reader.onerror = function (evt) {
                    console.log('error reading file');
                }
                reader.readAsText(files[i], 'UTF-8');
            }
            run_scanner();
        }, false);

        async function YaraScanner(yara_module) {
            window.yara_eng = yara_module;
            await this.yara_worker();
        }

        async function check_for_yara_errors() {
            const yara_matches = window.yara_eng.run('test', window.raw_yara_rules);
            if (yara_matches.compileErrors.size() === 0) {
                return false;
            }
            for (let i = yara_matches.compileErrors.size() - 1; i >= 0; i--) {
                const compileError = yara_matches.compileErrors.get(i);
                if (!compileError.warning) {
                    window.scan_error = true;
                    console.error(`Error on line ${compileError.lineNumber}: ${compileError.message} in YARA rules`);
                    throw new OperationError(`Error on line ${compileError.lineNumber}: ${compileError.message}`);
                }
            }
        }

        async function get_yara_rules(rules_url) {
            let response;
            try {
                response = await fetch(rules_url);
            }
            catch (e) {
                console.error(`Error while fetching rules: ${e.message}`);
                await this.get_rules_from_ls();
                return false;
            }

            if (response.ok) {
                window.raw_yara_rules = await response.text();
                localStorage.setItem('raw_rules', window.raw_yara_rules);
                return true;
            }
            console.error('Could not fetch rules');
            await this.get_rules_from_ls();
            return false;
        }

        async function get_rules_from_ls() {
            const raw_rules = localStorage.getItem('raw_rules');
            if (!raw_rules.length) {
                console.error('No rules saved in Localstorage');
                throw Exception;
            }
            window.raw_yara_rules = raw_rules;
        }

        async function yara_worker() {
            while (window.scan_queue.length > 0) {
                const time_start = Date.now();
                const scan_item = window.scan_queue.shift();
                window.last_item = scan_item;
                const yara_matches = window.yara_eng.run(scan_item[1], window.raw_yara_rules);
                ////console.info(scan_item[0].webkitRelativePath)
                ////let time_end = Date.now();
                ////let time_diff = time_end - time_start;
                ////console.info(`Scan took ${time_diff}ms`);

                if (yara_matches.matchedRules.size() === 0)
                    continue;
                ////console.log('File:');
                ////console.table(scan_item[0]);

                const rules = [];
                for (let i = yara_matches.matchedRules.size() - 1; i >= 0; i--) {
                    let metadata = {};
                    const rule = yara_matches.matchedRules.get(i);
                    for (let j = rule.metadata.size() - 1; j >= 0; j--) {
                        metadata[rule.metadata.get(j).identifier] = rule.metadata.get(j).data;
                    }
                    rules.push(rule.ruleName);
                    ////console.log('Matched rule name:');
                    ////console.table(rule.ruleName);
                    ////console.log('Matched rule metadata:');
                    ////console.table(metadata);
                }
                document.getElementById('listing_malicious').value += `${scan_item[0].webkitRelativePath} (${rules.join(', ')})\n`;
            }
        }

        function run_scanner() {
            new Module().then(async yara_module => {
                //(async function () {
                try {
                    window.yara_eng = yara_module;
                    await check_for_yara_errors();
                    await this.yara_worker();
                } catch (error) {
                    if (error === 'abort(OOM). Build with -s ASSERTIONS=1 for more info.') {
                        ////console.log(window.last_item)
                        window.scan_queue.unshift(window.last_item);
                        run_scanner();
                        return;
                    }
                    if (window.scan_error) {
                        document.getElementById('scan_status').innerText = 'Scan-Fehler';
                        return;
                    }
                }
                if (window.scan_queue.length === 0) {
                    const scan_end = Date.now();
                    const scan_diff = scan_end - window.scan_start;
                    document.getElementById('scan_status').innerText = `Scan beendet nach ${scan_diff}ms`;
                    console.info(`Whole scan took ${scan_diff}ms`);
                    alert(`Fertig nach ${scan_diff}ms`);
                }
                //})(Module);
            });
        }
    </script>

</body>

</html>